# インゲーム終了時フロー変更計画書

## 概要

現在のインゲーム終了時のフローは、インゲームから直接アウトゲームへ遷移しています。これを、インゲーム終了時にリザルトウィンドウを表示し、リザルトウィンドウでの終了イベント発生後にアウトゲームへ遷移するように変更します。

## 現状の解析結果

### シーン遷移ロジックの特定

*   `Assets/Scripts/Runtime/InfraStructure/Ingame/Sequence/IngameStartSequence.cs` 内の `GoToOutGameScene()` メソッドが、インゲーム終了時のアウトゲームへのシーン遷移を担当しています。
*   この `GoToOutGameScene()` メソッドは、`Assets/Scripts/Runtime/UseCase/Ingame/System/InGameLoopUseCase.cs` のコンストラクタに `onGameEndedCallback` として渡されています。
*   `InGameLoopUseCase` がゲーム終了を検知すると、この `onGameEndedCallback` が呼び出され、結果として `GoToOutGameScene()` が実行されます。

### `GoToOutGameScene()` の詳細

```csharp
private async void GoToOutGameScene()
{
    if (_isTransitioning) return;
    _isTransitioning = true;

    await SceneLoader.UnloadScene(SceneListEnum.Stage.ToString());
    await SceneLoader.UnloadScene(SceneListEnum.Ingame.ToString());

    await SceneLoader.LoadScene(SceneListEnum.Outgame.ToString());
    await SceneLoader.LoadScene(SceneListEnum.Stage.ToString()); // Outgameシーンロード後のStageシーン再ロード
    SceneLoader.SetActiveScene(SceneListEnum.Stage.ToString());
}
```

*   `Stage` シーンと `Ingame` シーンをアンロードします。
*   `Outgame` シーンをロードします。
*   再度 `Stage` シーンをロードし、アクティブシーンに設定しています。これはアウトゲームのメイン画面（ステージ選択など）で使用される共通の `Stage` シーンであると推測されます。

## 変更計画

### 1. 新しい `UseCase` の導入

リザルト表示のロジックをカプセル化するため、`IngameResultUseCase` (仮称) を導入します。この `UseCase` はリザルトデータの受け渡し、リザルトウィンドウの表示、そしてリザルトウィンドウでのユーザー操作（例: 「次へ」ボタンクリック）を待ち、その後にアウトゲームへの遷移をトリガーする役割を担います。

### 2. `InGameLoopUseCase` の変更

`InGameLoopUseCase` がゲーム終了を検知した際に、直接 `GoToOutGameScene()` を呼び出すのではなく、新しく導入する `IngameResultUseCase` を呼び出すように変更します。

### 3. `IngameStartSequence` の変更

`IngameStartSequence` は `IngameLoopUseCase` に `GoToOutGameScene` を渡す代わりに、`IngameResultUseCase` の実行をトリガーする処理を渡すように変更します。`GoToOutGameScene` メソッド自体は `IngameResultUseCase` の中で呼び出されるか、または `IngameStartSequence` 内の別のメソッドとしてリファクタリングされ、`IngameResultUseCase` から呼び出される形になります。

### 4. UIの実装

リザルトウィンドウのUI (`VisualElement` または `GameObject`) と、それを表示・制御する `Presenter` および `ViewModel` を実装します。`IngameResultUseCase` はこの `Presenter` を介してUIとやり取りを行います。

## 想定される影響範囲

*   `Assets/Scripts/Runtime/InfraStructure/Ingame/Sequence/IngameStartSequence.cs`: `InGameLoopUseCase` のコンストラクタに渡すコールバックの変更、`GoToOutGameScene` メソッドの変更または移動。
*   `Assets/Scripts/Runtime/UseCase/Ingame/System/InGameLoopUseCase.cs`: ゲーム終了時のコールバック呼び出し箇所の変更。
*   新規ファイル:
    *   `Assets/Scripts/Runtime/UseCase/Ingame/Result/IngameResultUseCase.cs` (仮称)
    *   `Assets/Scripts/Runtime/Presenter/Ingame/Result/IngameResultPresenter.cs` (仮称)
    *   `Assets/Scripts/Runtime/UI/Ingame/Result/UIResultWindow.cs` (仮称) および関連するUXML/USSファイル。

## 今後の作業

1.  `IngameResultUseCase` の設計と実装。
2.  リザルトウィンドウのUI/UX設計と実装。
3.  関連する `Presenter` および `ViewModel` の実装。
4.  `InGameLoopUseCase` および `IngameStartSequence` の修正。
5.  テストコードの追加または修正。
