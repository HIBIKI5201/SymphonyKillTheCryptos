# デッキシステム計画書

## 1. 概要

本計画書は、ゲームのインゲームにおけるデッキシステム（デッキと手札）の機能、構造、および関連するコンポーネントについて記述する。本計画書では、インゲームでデッキデータを受け取り、カードのドロー、手札管理、ワード入力、カードの実行に至るまでの範囲を扱う。アウトゲームにおけるデッキ構築やカード収集などの機能は本計画書の範囲外とする。

## 2. ゴール

*   インゲームでカードデータを基にデッキを構築し、手札にカードを生成・管理できること。
*   デッキおよび手札の枚数制限を適切に管理できること。
*   ドロー条件に基づき、デッキから手札へカードを自動で補充できること。
*   プレイヤーの入力（キーボード入力など）に応じて手札のカードのワード進行を管理できること。
*   ワード入力完了後、カード効果を発動し、その効果がゲームに反映されること。
*   インゲームのUIに手札のカードが適切に表示され、ワードの入力進捗が視覚的にフィードバックされること。

## 3. 主要コンポーネント

### 3.1. Entity層

*   **`CardEntity`**:
    *   カードのランタイムインスタンスを表す。
    *   静的なカードデータ (`CardData`) と、ワード入力に関連するデータ (`WordEntity`) を保持する。
    *   `WordEntity` はカードの難易度に応じて適切なワードが設定され、入力進捗を管理する。
    *   ゲーム内での状態（例: 使用済み、手札にあるかなど）を管理する。
*   **`CardData`**:
    *   カードの名前、説明、アイコン、難易度、効果 (`ICardContent` の配列) など、静的なカード情報を定義するScriptableObject。
*   **`DeckEntity` (新規または既存の拡張)**:
    *   手札に入る可能性があるカードデータのリストを管理する。
    *   **最大枚数**: 初期24枚、アップグレードにより最大30枚。
    *   カードは重複を許容し、ドロー時の確率に「重さ」が影響する可能性がある。
*   **`HandEntity` (既存の `CardHandEntity` を改称または拡張)**:
    *   発動可能なカード（`CardEntity`）の一覧（手札）を管理する。
    *   **最大枚数**: 初期3枚、アップグレードにより最大6枚。
    *   手札の枚数が最大値以下になった場合にドローをトリガーする。
*   **`WordEntity`**:
    *   カードに紐づくワードとその入力進捗を管理する。
    *   ワードの難易度、および複数回のワード入力が必要なロジックを管理する。
    *   ワード選択の条件（カード難易度以下、手札内で重複しない、先頭文字が重複しない）を考慮してワードを提供する。
*   **`ComboEntity`**:
    *   コンボの状態やスコアを管理するエンティティ。`CardUseCase` から利用される。
*   **`CardExecutionQueueEntity`**:
    *   実行待ちの `CardEntity` をキューとして管理する。

### 3.2. UseCase層

*   **`DeckUseCase` (新規)**:
    *   **責務**:
        *   デッキの初期化と管理。
        *   ドローロジックの実行。
        *   デッキの最大枚数変更などのアップグレード処理。
    *   **依存**: `DeckEntity`, `WordDataBase`
*   **`HandUseCase` (既存の `CardUseCase` の責務を分割または拡張)**:
    *   **責務**:
        *   手札のカードの管理（追加、削除）。
        *   プレイヤーの文字入力に応じた手札の `WordEntity` の処理。
        *   カードのゲージが溜まった際のカード効果発動。
        *   手札の最大枚数変更などのアップグレード処理。
    *   **依存**: `HandEntity`, `WordManager`, `CardExecutionUseCase`
*   **`WordSelectionUseCase` (新規または既存の `CardDrawer` に責務追加)**:
    *   **責務**:
        *   `WordEntity` に設定するワードの選択ロジック。
        *   ワード選択の条件（カード難易度以下、手札内で重複しない、先頭文字が重複しない）を厳密に適用する。
    *   **依存**: `WordDataBase`, `HandEntity` (手札内の使用中ワードを確認するため)
*   **`CardExecutionUseCase`**:
    *   `HandUseCase` と連携し、カードの実行順序とアニメーションに関するロジックを管理する。
    *   キュー内のカードを実行し、`ICardAnimationHandler` を介してアニメーションをトリガーする。

### 3.3. Presenter層

*   **`DeckPresenter` (新規)**:
    *   `DeckUseCase` からのイベントを購読し、UIにデッキの状態（残り枚数など）を通知する。
*   **`HandPresenter` (既存の `CardPresenter` を改称または拡張)**:
    *   `HandUseCase` からのイベントを購読し、それに応じてUI層 (`ICardUIManager`) に更新を指示する。
    *   `CardEntity` を `CardViewModel` に変換してUIに渡す。
*   **`CardViewModel`**:
    *   `CardEntity` のデータをUI表示に適した形式で提供する（ワード、アイコン、入力進捗など）。
*   **`ICardUIManager`**:
    *   UI操作のインターフェース。カードの追加、削除、移動、ワード入力進捗の更新などを抽象化する。

### 3.4. UI層

*   **`IngameUIManager`**:
    *   インゲーム全体のUIを統括し、`ICardUIManager` の実装を提供する。
    *   `UIElementDeck` と連携して手札のカードUIを管理する。
*   **`UIElementDeck`**:
    *   手札のカードを表示するための `VisualElement` コンテナ。
    *   `UIElementCard` を追加・削除し、カードの移動アニメーションなどを制御する。
*   **`UIElementCard`**:
    *   個々のカードのビジュアル表現を担当する `VisualElement`。`CardViewModel` のデータを表示し、ワードの入力進捗を視覚的にフィードバックする。

### 3.5. InfraStructure層

*   **`CardDataAsset`**:
    *   UnityのScriptableObjectとして定義された `CardData`。
*   **`CardInitializer`**:
    *   `DeckUseCase`, `HandUseCase` (または `CardUseCase`) を含むインゲームのカード関連コンポーネントを初期化するためのヘルパークラス。`IngameStartSequence` から利用される。
*   **`IngameStartSequence`**:
    *   ゲーム開始時の初期化シーケンスの一部として、`DeckUseCase`, `HandUseCase` などの主要なコンポーネネントのインスタンス化と依存性の注入を行う。
    *   初期デッキの構築や、ゲーム開始時の初期手札ドローをトリガーする。

## 4. 既存の実装との整合性および新規要素

### 4.1 既存の実装との整合性

*   既存の `CardEntity`, `CardData`, `ComboEntity`, `CardExecutionQueueEntity`, `CardExecutionUseCase` はそのまま活用可能。
*   既存の `CardUseCase` の責務を分割し、`DeckUseCase` と `HandUseCase` (または既存の `CardUseCase` を `HandUseCase` として拡張) に割り当てることで、より明確な責務分担と仕様への適合を図る。
*   `CardHandEntity` は `HandEntity` として機能拡張する。
*   `CardDrawer` は `WordSelectionUseCase` の一部として統合、または連携してワード選択機能を提供する。

### 4.2 新規導入要素

*   **`DeckEntity`**: デッキのデータと最大枚数管理。
*   **`DeckUseCase`**: ドローロジックとデッキ管理。
*   **`WordSelectionUseCase`**: ワード選択条件を厳密に適用するロジック。

## 5. 制作範囲

本計画書における制作範囲は、以下の通りとする。

*   インゲームでカードデータを基に初期デッキを構築する機能。
*   デッキの最大枚数（初期24枚、アップグレードにより最大30枚）管理機能。
*   手札の最大枚数（初期3枚、アップグレードにより最大6枚）管理機能。
*   手札の枚数が最大値以下になった場合の自動ドロー機能。
*   ドロー時のカード抽選ロジック（デッキから手札にあるものを除いたものから抽選、重さによる確率変動）。
*   手札に入ったカードへのワード表示と、カード難易度に応じたワード難易度・複数回入力ロジック。
*   ワード選択条件（カード難易度以下、手札内の使用中ワードと重複しない、手札のワードの先頭文字が含まれていない）を実装したワード供給システム。
*   プレイヤーのタイピング入力によるカードゲージの蓄積と、ゲージ満タン時のカード効果発動。
*   インゲームUIでのデッキ枚数、手札カード、ワード入力進捗の視覚的フィードバック。

**具体的に本計画書で実装を対象としない範囲:**

*   アウトゲームにおけるデッキ構築UI
*   カードの取得、進化、合成などのアウトゲームロジック
*   カードデータの永続化（セーブ・ロード）
*   スキルツリーなどによるデッキ・手札枚数アップグレードUI

## 6. 今後の作業

*   `DeckEntity` および `DeckUseCase` の設計と実装。
*   `HandEntity` (既存の `CardHandEntity` ) および `HandUseCase` (既存の `CardUseCase` から責務を分割・拡張) の設計と実装。
*   `WordSelectionUseCase` の設計と実装。
*   既存の `IngameStartSequence` の修正、および `CardInitializer` のアップデート。
*   デッキと手札の枚数アップグレードに関する処理の組み込み（今回はUIは対象外だが、機能としては考慮）。
*   関連するPresenterおよびUIの修正・拡張。
*   テストコードの追加または修正。